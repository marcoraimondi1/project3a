<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Stock Chart Viewer</title>
  </head>
  <body>
    <h1>Stock Chart Viewer</h1>

    <form id="chartForm" method="post" action="/chart">
      <p>
        <label for="symbol">Choose Symbol:</label>
        <select id="symbol" name="symbol">
          <option value="AAPL">AAPL</option>
          <option value="GOOGL">GOOGL</option>
          <option value="MSFT">MSFT</option>
          <option value="AMZN">AMZN</option>
          <option value="TSLA">TSLA</option>
        </select>
      </p>

      <p>
        <label for="chart_type">Choose Chart Type:</label>
        <select id="chart_type" name="chart_type">
          <option value="line">Line</option>
          <option value="bar">Bar</option>
        </select>
      </p>

      <p>
        <label for="time_series">Choose Time Series:</label>
        <select id="time_series" name="time_series">
          <option value="">Select a Time Series</option>
          <option value="TIME_SERIES_INTRADAY">Intraday</option>
          <option value="TIME_SERIES_DAILY">Daily</option>
          <option value="TIME_SERIES_WEEKLY">Weekly</option>
          <option value="TIME_SERIES_MONTHLY">Monthly</option>
        </select>
      </p>

      <p id="intervalRow" style="display:none">
        <label for="interval">Intraday Interval (minutes):</label>
        <select id="interval" name="interval">
          <option value="1min">1</option>
          <option value="5min" selected>5</option>
          <option value="15min">15</option>
          <option value="30min">30</option>
          <option value="60min">60</option>
        </select>
      </p>

      <p>
        <label for="start_date">Start Date:</label>
        <input type="date" id="start_date" name="start_date" />
      </p>

      <p>
        <label for="end_date">End Date:</label>
        <input type="date" id="end_date" name="end_date" />
      </p>

      <p>
        <input type="submit" value="Submit" />
      </p>
    </form>

    <div id="apiResult" style="white-space:pre-wrap; margin-top:12px; color:#333"></div>
    <div id="chartHolder" style="margin-top:12px; display:none">
      <canvas id="stockChart" width="800" height="400"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
      document.getElementById('chartForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const data = {
          symbol: document.getElementById('symbol').value,
          chart_type: document.getElementById('chart_type').value,
          time_series: document.getElementById('time_series').value,
          start_date: document.getElementById('start_date').value,
          end_date: document.getElementById('end_date').value,
          interval: document.getElementById('interval') ? document.getElementById('interval').value : undefined
        };

        const resultDiv = document.getElementById('apiResult');
        resultDiv.textContent = 'Loading...';

        try {
          const res = await fetch('/api/chart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          const json = await res.json();

          if (!res.ok) {
            resultDiv.textContent = 'Error: ' + (json.error || res.statusText);
            return;
          }

          resultDiv.textContent = '';
          const holder = document.getElementById('chartHolder');
          holder.style.display = 'block';

          const ctx = document.getElementById('stockChart').getContext('2d');

          const labels = json.labels || [];
          const datasets = [];

          if (json.open) {
            datasets.push({
              label: 'Open',
              data: json.open
            });
          }
          if (json.high) {
            datasets.push({
              label: 'High',
              data: json.high
            });
          }
          if (json.low) {
            datasets.push({
              label: 'Low',
              data: json.low
            });
          }
          if (json.close) {
            datasets.push({
              label: 'Close',
              data: json.close
            });
          }

          if (window._stockChartInstance) {
            window._stockChartInstance.destroy();
          }

          const chartType = data.chart_type || 'line';

          window._stockChartInstance = new Chart(ctx, {
            type: chartType,
            data: {
              labels: labels,
              datasets: datasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              interaction: { mode: 'index', intersect: false },
              plugins: {
                title: {
                  display: true,
                  text: 'Data for ' + data.symbol
                },
                legend: {
                  display: true,
                  position: 'bottom'
                }
              },
              scales: {
                x: {
                  ticks: {
                    maxRotation: 45,
                    minRotation: 45
                  }
                }
              }
            }
          });
        } catch (err) {
          resultDiv.textContent = 'Fetch error: ' + err.message;
        }
      });

      document.getElementById('time_series').addEventListener('change', function(e) {
        const v = e.target.value;
        const row = document.getElementById('intervalRow');
        if (v === 'TIME_SERIES_INTRADAY') {
          row.style.display = 'block';
        } else {
          row.style.display = 'none';
        }
      });
    </script>
  </body>
</html>
